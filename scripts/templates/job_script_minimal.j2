#!/bin/bash
#SBATCH --job-name={{ job_name }}
#SBATCH --nodes={{ total_nodes }}
#SBATCH --ntasks={{ total_nodes }}
#SBATCH --ntasks-per-node=1
{% if use_gpus_per_node_directive %}
#SBATCH --gpus-per-node={{ gpus_per_node }}
{% endif %}
{% if use_segment_sbatch_directive %}
#SBATCH --segment={{ total_nodes }}
{% endif %}
#SBATCH --account={{ account }}
#SBATCH --time={{ time_limit }}
#SBATCH --output=./outputs/%j/logs/sweep.log
#SBATCH --partition={{ partition }}
{% for key, value in sbatch_directives.items() %}
{% if value %}
#SBATCH --{{ key }}={{ value }}
{% else %}
#SBATCH --{{ key }}
{% endif %}
{% endfor %}

# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Minimal sbatch script - orchestration is handled by Python inside the container
# Config: {{ config_path }}
# Generated: {{ timestamp }}

set -e

# Setup output directories
WORK_DIR="${PWD}"
OUTPUT_DIR="${WORK_DIR}/outputs/${SLURM_JOB_ID}"
LOG_DIR="${OUTPUT_DIR}/logs"
mkdir -p "${LOG_DIR}"

# Redirect all output to log file
exec > >(tee "${LOG_DIR}/sweep_${SLURM_JOB_ID}.log")
exec 2>&1

echo "=========================================="
echo "ðŸš€ srtctl Sweep Orchestrator"
echo "=========================================="
echo "Job ID: ${SLURM_JOB_ID}"
echo "Config: {{ config_path }}"
echo "Nodes: ${SLURM_JOB_NUM_NODES}"
echo "Container: {{ container_image }}"
echo "Start: $(date)"
echo "=========================================="
echo ""

# Copy config to output directory for reference
cp "{{ config_path }}" "${OUTPUT_DIR}/config.yaml"

# Get head node (first node in allocation)
HEAD_NODE=$(scontrol show hostnames ${SLURM_NODELIST} | head -n1)
echo "Head node: ${HEAD_NODE}"
echo ""

# Run the orchestrator inside the container on the head node
# Mount srtctl source and install it, then run do_sweep
echo "Starting orchestrator on ${HEAD_NODE} inside container..."

srun --nodes=1 --ntasks=1 --nodelist=${HEAD_NODE} \
    --container-image="{{ container_image }}" \
    --container-mounts="{{ srtctl_source }}:/srtctl:ro,{{ config_path }}:/config.yaml:ro,${OUTPUT_DIR}:/outputs,${WORK_DIR}:/workspace" \
    --output="${LOG_DIR}/orchestrator_${SLURM_JOB_ID}.log" \
    bash -c '
        set -e
        echo "Installing srtctl inside container..."
        pip install --quiet /srtctl
        echo "Running orchestrator..."
        python3 -u -m srtctl.cli.do_sweep /config.yaml
    ' 2>&1 | tee "${LOG_DIR}/orchestrator_${SLURM_JOB_ID}.log"

EXIT_CODE=${PIPESTATUS[0]}

echo ""
echo "=========================================="
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ“ Sweep completed successfully"
else
    echo "âœ— Sweep failed (exit code: $EXIT_CODE)"
fi
echo "End: $(date)"
echo "=========================================="

exit ${EXIT_CODE}
